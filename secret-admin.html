<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Admin - Restricted Access</title>
    <link rel="icon" type="image/png" href="assets/logo.png">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .admin-container {
            max-width: 800px;
            margin: 100px auto;
            padding: 30px;
            background: #1e1e1e;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .login-box,
        .admin-panel {
            display: none;
            /* Hidden by default */
        }

        .show {
            display: block;
        }

        .file-list {
            margin-top: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
        }

        .file-item {
            background: #252525;
            padding: 5px;
            text-align: center;
        }

        .file-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            margin-bottom: 5px;
        }

        .copy-btn {
            font-size: 0.7rem;
            padding: 4px 8px;
            background: #333;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="admin-container">
        <h2>Confidential Area</h2>
        <div id="message" style="color: var(--accent-color); margin-bottom: 15px;"></div>

        <!-- Login Form -->
        <div id="login-box" class="login-box show">
            <p style="margin-bottom: 20px;">Please enter your credentials.</p>
            <div class="contact-form">
                <input type="text" id="username" placeholder="Username">
                <input type="password" id="password" placeholder="Password">
                <button type="button" class="btn primary-btn" onclick="attemptLogin()">Access Dashboard</button>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="admin-panel" class="admin-panel">

            <!-- Tabs or Sections -->
            <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                <button class="btn" onclick="showSection('upload')">Uploads</button>
                <button class="btn" onclick="showSection('cv')">CV / Resume</button>
                <button class="btn" onclick="showSection('messages')">Messages</button>
            </div>

            <!-- Upload Section -->
            <div id="section-upload">
                <h3 style="margin-bottom: 20px;">Upload Assets (Images)</h3>
                <form id="uploadForm" class="contact-form">
                    <input type="file" id="imageInput" accept="image/*" required>
                    <button type="submit" class="btn primary-btn">Upload Image</button>
                </form>
                <div id="file-list" class="file-list"></div>
            </div>

            <!-- CV Section -->
            <div id="section-cv" style="display:none;">
                <h3 style="margin-bottom: 20px;">Upload CV</h3>
                <p style="color: #666; margin-bottom: 10px;">Upload your resume as a PDF. It will be accessible via the
                    homepage link.</p>
                <form id="cvForm" class="contact-form">
                    <input type="file" id="cvInput" accept=".pdf" required>
                    <button type="submit" class="btn primary-btn">Upload CV</button>
                </form>
                <div style="margin-top: 20px;">
                    <h4>Current CV:</h4>
                    <a href="/assets/uploads/resume.pdf" target="_blank" style="color: var(--accent-color);">View
                        Current Resume</a>
                </div>
            </div>

            <!-- Messages Section -->
            <div id="section-messages" style="display:none;">
                <h3 style="margin-bottom: 20px;">Contact Messages</h3>
                <div id="message-list" style="display: flex; flex-direction: column; gap: 15px;">
                    <!-- Messages go here -->
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- [EDIT] CREDENTIALS HERE ---
        const ADMIN_USER = "barron16";
        const ADMIN_PASS = "Barron231604";

        function attemptLogin() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;

            if (user === ADMIN_USER && pass === ADMIN_PASS) {
                document.getElementById('login-box').classList.remove('show');
                document.getElementById('admin-panel').classList.add('show');
                document.getElementById('message').innerText = "Welcome back, Admin.";
                loadImages();
                loadMessages();
            } else {
                alert("Invalid Credentials");
            }
        }

        function showSection(section) {
            ['upload', 'cv', 'messages'].forEach(s => {
                document.getElementById('section-' + s).style.display = (s === section) ? 'block' : 'none';
            });
        }

        // Handle Image Upload
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            uploadFile('imageInput', '/api/upload');
        });

        // Handle CV Upload
        document.getElementById('cvForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            // We want to force the filename to be 'resume.pdf' ideally, or just upload it and let admin know URL.
            // For simplicity, we just upload. The prompt implies "generic innovative link" which might just link to whatever is latest, 
            // but fixed 'resume.pdf' is cleaner. Backend uses original name usually.
            // Let's just upload.
            uploadFile('cvInput', '/api/upload', true);
        });

        async function uploadFile(inputId, url, isCV = false) {
            const fileInput = document.getElementById(inputId);
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            // If it's CV, we might ideally rename it on server, but our simple server keeps original name.
            // The user will have to copy the link or we teach them to name it resume.pdf.
            formData.append('file', file);

            try {
                const response = await fetch(url, { method: 'POST', body: formData });
                if (response.ok) {
                    const result = await response.json();
                    alert("Upload Successful: " + result.path);
                    if (!isCV) loadImages();
                    // If CV, maybe display the link
                    if (isCV) {
                        alert("IMPORTANT: If you want the main link to work automatically, ensure this file was named 'resume.pdf' before uploading. Or update index.html with: " + result.path);
                    }
                } else {
                    alert("Upload Failed.");
                }
            } catch (err) {
                console.error(err);
                alert("Error uploading.");
            }
        }

        async function loadImages() {
            try {
                const res = await fetch('/api/images');
                if (res.ok) {
                    const uploads = await res.json();
                    const list = document.getElementById('file-list');
                    list.innerHTML = '';
                    uploads.forEach(item => {
                        // Only show images in image tab
                        if (!item.type.includes('pdf')) {
                            const div = document.createElement('div');
                            div.className = 'file-item';
                            div.innerHTML = `
                                <img src="${item.url}" alt="upload">
                                <button class="copy-btn" onclick="navigator.clipboard.writeText('${item.url}')">Copy Link</button>
                            `;
                            list.appendChild(div);
                        }
                    });
                }
            } catch (e) {
                console.log("Could not load images.");
            }
        }

        async function loadMessages() {
            try {
                const res = await fetch('/api/messages');
                if (res.ok) {
                    const msgs = await res.json();
                    const list = document.getElementById('message-list');
                    list.innerHTML = '';
                    if (msgs.length === 0) list.innerHTML = '<p>No messages yet.</p>';

                    msgs.reverse().forEach(msg => {
                        const div = document.createElement('div');
                        div.style.background = '#252525';
                        div.style.padding = '15px';
                        div.style.borderLeft = '3px solid var(--accent-color)';
                        div.innerHTML = `
                            <div style="font-size: 0.8rem; color: #888; margin-bottom: 5px;">${new Date(msg.date).toLocaleString()}</div>
                            <div style="font-weight: bold; font-size: 1.1rem; color: #fff;">${msg.name} <span style="font-weight:normal; font-size:0.9rem; color:#aaa;">(${msg.email})</span></div>
                            <div style="margin-top: 10px; color: #ddd;">${msg.message}</div>
                        `;
                        list.appendChild(div);
                    });
                }
            } catch (e) {
                console.log("Could not load messages.");
            }
        }
    </script>
</body>

</html>